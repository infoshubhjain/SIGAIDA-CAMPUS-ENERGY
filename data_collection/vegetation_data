import ee
ee.Authenticate()
ee.Initialize(project='sigaida')

import pandas as pd
import sqlite3


#Load Sentinel-2 image collection
urbana_champaign = ee.Geometry.Rectangle([-88.32, 40.05, -88.15, 40.15])
collections = ee.ImageCollection('COPERNICUS/S2_HARMONIZED')
filtered = collections.filter(ee.Filter.date('2017-03-28', '2025-11-01')).filter(ee.Filter.bounds(urbana_champaign)).filter(ee.Filter.lt("CLOUDY_PIXEL_PERCENTAGE", 30))


#Define function to compute NDVI
def computeNDVI(image):
    ndvi = image.normalizedDifference(['B8', 'B4']).rename("NDVI")
    return image.addBands(ndvi)

ndvi_collection = filtered.map(computeNDVI)

#Compute average of NDVI over region per month
def monthly_ndvi(year, month):
    start = ee.Date.fromYMD(year, month, 1)
    end = start.advance(1, "month")
    month_collection = ndvi_collection.filterDate(start, end)
    mean_ndvi = month_collection.select("NDVI").mean().reduceRegion(
        reducer=ee.Reducer.mean(),
        geometry=urbana_champaign,
        scale=10
    )
    return {
        "year": year,
        "month": month,
        "ndvi": mean_ndvi.get("NDVI")
    }

#Store mean NDVI for each month in a datframe
records = []
for year in range(2019, 2026):
    for month in range(1, 13):
        info = (monthly_ndvi(year, month))
        try:
            ndvi_value = info["ndvi"].getInfo()
            records.append({"year": year, "month": month, "ndvi": ndvi_value})
        except Exception:
            ndvi_value = None
        

df = pd.DataFrame(records)
print(df.head)

# Store in SQLite
conn = sqlite3.connect("campus_data.db")
table_name = "vegetation_data"
df.to_sql(table_name, conn, if_exists="replace", index=False)
conn.close()